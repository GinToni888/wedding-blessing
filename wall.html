<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Maggie & Stanley Wedding Wall</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:italic,wght@0,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cream-bg: #fdfaf5;
            --sage-green: #7d8c78;
            --flower-pink: #f8e1e1;
            --gold: #c5a059;
            --text-color: #4a4a4a;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--cream-bg);
            font-family: "STFangsong", "FangSong", "仿宋", "Adobe Fangsong", serif;
            -webkit-font-smoothing: antialiased;
        }

        .background-layer {
            position: fixed; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #ffffff 0%, #fdf5e6 100%);
            z-index: -5;
        }

        /* --- 背景綠植系統 --- */
        .forest-container {
            position: fixed; width: 100%; height: 100%;
            pointer-events: none; z-index: -2; /* 確保在卡片後方 */
        }

        .leaf-group {
            position: absolute; fill: var(--sage-green); opacity: 0.6;
            animation: forestSway 10s ease-in-out infinite; filter: blur(2px);
        }
        .top-left { top: -40px; left: -40px; width: 450px; }
        .bottom-right { bottom: -60px; right: -60px; width: 500px; transform: rotate(180deg); }

        .flower { fill: var(--flower-pink); opacity: 0; transform: scale(0); transition: all 2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .blooming .flower { opacity: 0.8; transform: scale(1); }
        @keyframes forestSway { 0%, 100% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } }

        /* --- 蝴蝶系統 --- */
        .butterfly {
            position: fixed; width: 20px; height: 20px; background: rgba(255, 255, 255, 0.8);
            border-radius: 50% 50% 0 50%; pointer-events: none; z-index: 50; filter: blur(1px); display: none;
        }

        /* --- 訊息容器設置 --- */
        #display-container {
            position: relative; /* 為絕對定位的卡片提供基準 */
            width: 100vw; height: 100vh;
            overflow: hidden;
        }

        /* --- 核心：竹葉形狀訊息卡片 --- */
        .message-card {
            position: absolute; /* 絕對定位以實現重疊和移動 */
            top: 50%; left: 50%;
            /* 初始狀態：居中 */
            transform: translate(-50%, -50%) scale(1) rotate(0deg);
            
            /* 竹葉形狀塑造：利用不規則圓角 */
            border-radius: 80% 20% 80% 20% / 40% 60% 40% 60%;
            
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 80px 120px; /* 加大內邊距以適應尖角 */
            width: 850px; max-width: 80%; text-align: center;
            box-shadow: 0 30px 60px rgba(125, 140, 120, 0.15);
            
            /* 進場動畫：預設套用 */
            animation: leafEnter 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            z-index: 10; /* 確保新卡片在最上層 */
        }

        .sender { font-size: 22px; color: var(--sage-green); margin-bottom: 25px; letter-spacing: 0.2em; font-weight: bold; }
        .content { font-size: 32px; line-height: 1.8; color: var(--text-color); margin-bottom: 35px; word-break: keep-all; }
        .wedding-tag { font-family: 'Playfair Display', serif; font-style: italic; font-size: 18px; color: var(--gold); }

        /* --- 動畫定義區 --- */
        
        /* 1. 進場動畫：從下方浮現 */
        @keyframes leafEnter {
            from { opacity: 0; transform: translate(-50%, -30%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* 2. 退場動畫 A：飄向左上角植物區 */
        @keyframes floatToTL {
            to { 
                opacity: 0; 
                /* 移動到左上，縮小，旋轉，並變模糊 */
                transform: translate(-120%, -150%) scale(0.5) rotate(-15deg); 
                filter: blur(10px);
            }
        }

        /* 3. 退場動畫 B：飄向右下角植物區 */
        @keyframes floatToBR {
            to { 
                opacity: 0; 
                transform: translate(20%, 50%) scale(0.5) rotate(15deg); 
                filter: blur(10px);
            }
        }

        /* 退場用的 class */
        .card-exit-tl {
            z-index: 5; /* 退場時層級降低 */
            animation: floatToTL 2.5s ease-in-out forwards !important; /* 覆蓋進場動畫 */
        }
        .card-exit-br {
            z-index: 5;
            animation: floatToBR 2.5s ease-in-out forwards !important;
        }

        #status-info {
            position: fixed; bottom: 20px; left: 20px; font-size: 13px; color: #aaa;
            background: rgba(255,255,255,0.7); padding: 5px 15px; border-radius: 20px; z-index: 100;
        }
    </style>
</head>
<body onclick="this.focus();">

    <div class="background-layer"></div>

    <div class="forest-container" id="forest">
        <svg class="leaf-group top-left" viewBox="0 0 200 200">
            <circle cx="50" cy="80" r="40" /><circle cx="100" cy="50" r="45" /><circle cx="140" cy="90" r="35" />
            <circle class="flower" cx="60" cy="70" r="15" /><circle class="flower" cx="120" cy="60" r="20" />
        </svg>
        <svg class="leaf-group bottom-right" viewBox="0 0 200 200">
            <circle cx="50" cy="80" r="40" /><circle cx="100" cy="50" r="45" /><circle cx="140" cy="90" r="35" />
            <circle class="flower" cx="70" cy="60" r="18" /><circle class="flower" cx="130" cy="80" r="12" />
        </svg>
    </div>

    <div id="display-container">
        <div class="message-card active-card">
            <div class="sender">Maggie & Stanley</div>
            <div class="content">森林系祝福牆啟動中...<br>請點擊畫面任一處啟動空白鍵功能</div>
            <div class="wedding-tag">Love at Mandarin Oriental</div>
        </div>
    </div>

    <div id="status-info">等待資料同步...</div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        const gasUrl = "https://script.google.com/macros/s/AKfycby-P94fg0kooAipQFNCgBejG2EFx0JDT-8gC0A6mlEwISuEyUpyqBJk6XTrAR7FXGcWvQ/exec";

        let messages = [];
        let currentIndex = 0;
        let exitDirectionToggle = false; // 用來切換退場方向
        const statusInfo = document.getElementById('status-info');
        const displayContainer = document.getElementById('display-container');

        async function fetchMessages() {
            try {
                const response = await fetch(`${gasUrl}?t=${new Date().getTime()}`);
                const data = await response.json();
                if (data && data.length > 0) {
                    messages = data;
                    statusInfo.innerText = `✅ 同步成功: ${data.length} 則祝福`;
                    // 如果當前顯示的是初始訊息，立刻切換
                    const currentCard = document.querySelector('.active-card .content');
                    if (currentCard && currentCard.innerText.includes("啟動中")) rotateMessage();
                }
            } catch (err) { statusInfo.innerText = "❌ 連線失敗: " + err.message; }
        }

        // --- 全新的輪播邏輯：新增與移除 DOM 元素 ---
        function rotateMessage() {
            if (messages.length === 0) return;

            // 1. 找到當前正在顯示的舊卡片
            const oldCard = document.querySelector('.message-card.active-card');

            if (oldCard) {
                // 移除活躍標記
                oldCard.classList.remove('active-card');
                // 決定退場方向 (左右交替)
                exitDirectionToggle = !exitDirectionToggle;
                oldCard.classList.add(exitDirectionToggle ? 'card-exit-tl' : 'card-exit-br');
                
                // 2.5秒動畫結束後，從 DOM 中移除舊卡片元素
                setTimeout(() => {
                    if(oldCard.parentNode) oldCard.parentNode.removeChild(oldCard);
                }, 2500);
            }

            // 2. 準備新資料
            const data = messages[currentIndex];
            
            // 3. 創建全新的卡片元素
            const newCard = document.createElement('div');
            newCard.className = 'message-card active-card'; // 自動套用進場動畫
            newCard.innerHTML = `
                <div class="sender">— ${data.name} —</div>
                <div class="content">${data.msg.replace(/\n/g, '<br>')}</div>
                <div class="wedding-tag">Forever Love 2026.04</div>
            `;

            // 4. 將新卡片加入容器
            displayContainer.appendChild(newCard);

            // 更新索引
            currentIndex = (currentIndex + 1) % messages.length;
        }

        // --- 鏡開儀式保持不變 ---
        function triggerKagamiBiraki() {
            document.getElementById('forest').classList.add('blooming');
            spawnButterflies();
            confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 }, colors: ['#fdf5e6', '#7d8c78', '#c5a059', '#ffffff'], ticks: 300, scalar: 1.2 });
            statusInfo.innerText = "✨ 鏡開儀式落槌！蝴蝶飛舞、森林開花 ✨";
        }

        function spawnButterflies() {
            for (let i = 0; i < 15; i++) {
                const b = document.createElement('div'); b.className = 'butterfly'; b.style.display = 'block'; b.style.left = '50%'; b.style.top = '60%';
                document.body.appendChild(b);
                gsap.to(b, { x: (Math.random() - 0.5) * window.innerWidth * 1.5, y: (Math.random() - 1) * window.innerHeight * 1.5, rotation: Math.random() * 360, opacity: 0, duration: 4 + Math.random() * 2, ease: "power1.out", onComplete: () => b.remove() });
            }
        }

        window.addEventListener('keydown', (e) => { if (e.code === 'Space' || e.keyCode === 32) { e.preventDefault(); triggerKagamiBiraki(); } });

        fetchMessages();
        setInterval(fetchMessages, 20000);
        // 將輪播時間稍微拉長，讓退場動畫演完
        setInterval(rotateMessage, 9000); 
    </script>
</body>
</html>
