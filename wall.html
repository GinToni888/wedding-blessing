<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maggie's Wedding Wall - Master Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --bg-cream: #fdfaf5;
            --glass-base: rgba(255, 255, 255, 0.75);
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-cream);
            overflow: hidden;
            font-family: "STSong", "NSimSun", serif;
        }

        /* --- 背景與綠植圖層 --- */
        #bg-fixed-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -10;
            background: radial-gradient(circle at 50% 50%, rgba(224, 229, 209, 0.4) 0%, transparent 80%);
        }

        .bg-img {
            position: fixed;
            z-index: -5;
            pointer-events: none;
            opacity: 0.9;
        }
        .plant-tl { top: -5%; left: -5%; width: 45vw; max-width: 800px; }
        .plant-br { bottom: -5%; right: -5%; width: 40vw; max-width: 700px; }

        /* --- 主容器：確保 3D 視角 --- */
        #app-wrapper {
            position: relative;
            width: 100vw; height: 100vh;
            perspective: 1200px;
            z-index: 1;
            background: transparent;
        }

        /* --- 磨砂玻璃卡片 (絕對置中修復) --- */
        .blessing-card {
            position: absolute;
            /* 核心修正：利用 top/left 50% 定位 */
            top: 50%;
            left: 50%;
            width: 650px;
            padding: 60px 45px;
            box-sizing: border-box;
            
            /* 材質：磨砂玻璃 */
            background: var(--glass-base);
            -webkit-backdrop-filter: blur(25px) saturate(130%);
            backdrop-filter: blur(25px) saturate(130%);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 35px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.08);
            
            text-align: center;
            opacity: 0; /* 初始隱藏 */
            transform-style: preserve-3d;
        }

        .card-name {
            font-size: 1.6rem; color: #7a8a66; margin-bottom: 30px; 
            font-weight: bold; letter-spacing: 0.15em;
        }
        .card-content {
            font-size: 1.15rem; color: #333; line-height: 2; 
            letter-spacing: 0.08em; white-space: pre-line;
        }

        #status-bar {
            position: fixed; bottom: 15px; left: 15px;
            font-size: 12px; color: rgba(122, 138, 102, 0.4);
            z-index: 100;
        }
    </style>
</head>
<body>

    <div id="bg-fixed-layer"></div>
    <img src="plant-top-left.png" class="bg-img plant-tl" alt="">
    <img src="plant-bottom-right.png" class="bg-img plant-br" alt="">

    <div id="app-wrapper">
        <div id="card-container"></div>
    </div>

    <div id="status-bar">Maggie's Wedding System Loading...</div>
<script>
    let messages = [];
    let currentIndex = 0;
    const GAS_URL = "https://script.google.com/macros/s/AKfycby-P94fg0kooAipQFNCgBejG2EFx0JDT-8gC0A6mlEwISuEyUpyqBJk6XTrAR7FXGcWvQ/exec";

    async function init() {
        await update();
        if (messages.length > 0) {
            startLoop();
        } else {
            // 保險機制：若資料庫全空，顯示一則預設祝福，確保畫面不留白
            messages = [{name: "Maggie & Stanley", content: "Welcome to our Wedding!\n謝謝大家的祝福。", status: "ok"}];
            startLoop();
        }
    }

    async function update() {
        try {
            const r = await fetch(`${GAS_URL}?t=${Date.now()}`);
            const d = await r.json();
            const filtered = d.filter(m => m.status && m.status.toLowerCase() === 'ok');
            if (filtered.length > 0) {
                messages = filtered;
                document.getElementById('status-bar').innerText = `已同步 ${messages.length} 則祝福`;
            }
        } catch (e) { 
            console.warn("同步失敗，維持目前的播放清單"); 
        }
    }

    function startLoop() {
        const container = document.getElementById('card-container');
        
        // 1. 取得當前要播放的訊息
        const msg = messages[currentIndex];
        
        // 2. 建立新的卡片 DOM 元件 (確保每次都是全新的物件)
        const card = document.createElement('div');
        card.className = 'blessing-card';
        card.innerHTML = `
            <div class="card-name">${msg.name}</div>
            <div class="card-content">${msg.content}</div>
        `;
        container.appendChild(card);

        // 3. 建立動畫時間軸
        const tl = gsap.timeline({
            onComplete: () => {
                // 當退場動畫完成後：
                card.remove(); // 徹底移除 DOM
                
                // 計算下一張索引 (取餘數邏輯：最後一張會自動跳回第一張)
                currentIndex = (currentIndex + 1) % messages.length;
                
                // 立即啟動下一次循環 (遞迴)
                startLoop();
            }
        });

        // --- 核心動畫序列 ---
        tl.fromTo(card, 
            { 
                opacity: 0, 
                scale: 0.7,   // 從更小的地方開始
                z: -300,     // 從深處飛入
                xPercent: -50, 
                yPercent: -50,
                left: "50%",
                top: "50%"
            }, 
            { 
                opacity: 1, 
                scale: 1, 
                z: 0, 
                duration: 1.8, 
                ease: "power3.out" 
            }
        )
        // 停留時間 (6秒)
        .to(card, { opacity: 1, duration: 6 }) 
        // 退場：執行妳要求的「縮小往後」動作
        .to(card, { 
            opacity: 0, 
            scale: 0.6,   // 縮小
            z: -500,     // 往更深處飄走
            duration: 1.5, 
            ease: "power2.in" 
        });
    }

    // 啟動系統
    window.onload = init;
    
    // 每 2 分鐘背景更新一次資料，但不中斷當前動畫
    setInterval(update, 120000); 
</script>
</body>
</html>
