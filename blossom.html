<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Maggie & Stanley Wedding Wall</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:italic,wght@0,700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --cream-bg: #fdfaf5; --sage-green: #7d8c78; --gold: #c5a059; --text-color: #4a4a4a; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body, html { 
            width: 100vw; height: 100vh; 
            overflow: hidden; 
            background-color: var(--cream-bg); 
            font-family: "Playfair Display", "STFangsong", "華康儷中宋", "NSimSun", serif; 
        }

        #bg-sharp { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('wedding-bg.png') no-repeat center center; background-size: cover; z-index: 1; }
        #bg-blurred { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('wedding-bg.png') no-repeat center center; background-size: cover; z-index: 2; filter: blur(25px); transform: scale(1.1); transition: opacity 5s ease-in-out; will-change: opacity; }
        
        #display-wrapper { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 10; perspective: 1800px; }
        
        .message-card { 
            position: relative; background: rgba(255, 255, 255, 0.96); 
            border: 1px solid #f0f0f0; outline: 12px solid rgba(255, 255, 255, 0.5); 
            padding: 80px 110px; width: 1050px; text-align: center; 
            box-shadow: 0 30px 70px rgba(0,0,0,0.07); border-radius: 4px; 
            animation: cardEnter 2.5s forwards; 
            font-family: "STFangsong", "NSimSun", serif; 
        }

        .sender { font-size: 26px; color: var(--sage-green); margin-bottom: 30px; letter-spacing: 0.25em; font-weight: bold; }
        .content { font-size: 26px; line-height: 1.9; color: var(--text-color); margin-bottom: 40px; font-weight: 500; word-wrap: break-word; white-space: pre-wrap; }
        .wedding-tag { font-family: 'Playfair Display', serif; font-style: italic; font-size: 18px; color: var(--gold); }

        #ceremony-overlay {
            position: fixed; top: -110%; left: 0; width: 100vw; height: 100vh;
            z-index: 2000; background-color: #2d3e2d;
            background-image: url('flower-wall.png'); 
            background-size: cover; background-position: center;
        }

        .flower-item {
            position: absolute; 
            background-size: contain; background-repeat: no-repeat; background-position: center;
            border: none !important; outline: none !important;
            transform: scale(0); will-change: transform;
        }

        @keyframes cardEnter { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="bg-sharp"></div>
    <div id="bg-blurred"></div>
    <div id="display-wrapper"><div id="card-container"></div></div>
    
    <div id="ceremony-overlay"></div>

    <script>
        const gasUrl = "https://script.google.com/macros/s/AKfycby-P94fg0kooAipQFNCgBejG2EFx0JDT-8gC0A6mlEwISuEyUpyqBJk6XTrAR7FXGcWvQ/exec";
        let isCeremonyActive = false;
        let messages = [{ name: "Maggie & Stanley", msg: "歡迎來到我們的婚禮！" }];
        let placedFlowers = []; 

        function isOverlapping(newX, newY, newSize) {
            for (let flower of placedFlowers) {
                const dx = newX - flower.x;
                const dy = newY - flower.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                // 減小緩衝距離到 10px 以容納 100 朵花
                if (distance < (newSize/2 + flower.size/2 + 10)) return true;
            }
            return false;
        }

        function initCeremony() {
            const overlay = document.getElementById('ceremony-overlay');
            const flowerFiles = ['flower1.gif', 'flower2.gif', 'flower3.gif'];
            
            // --- 總數 100 朵：60, 35, 5 分佈 ---
            const zoneSettings = [
                { id: 1, count: 60, yMin: 2, yMax: 32 }, 
                { id: 2, count: 35, yMin: 35, yMax: 65 }, 
                { id: 3, count: 5,  yMin: 68, yMax: 92 }  
            ];

            zoneSettings.forEach(zone => {
                for (let i = 0; i < zone.count; i++) {
                    const f = document.createElement('div');
                    f.className = 'flower-item';
                    
                    const chance = Math.random();
                    let size, file;

                    // --- Flower 1 佔 70% 比例 ---
                    if (chance < 0.7) { 
                        file = flowerFiles[0]; size = 150; 
                    } else {
                        file = (chance < 0.85 ? flowerFiles[1] : flowerFiles[2]); 
                        size = 100; // Flower 2 & 3 固定 100px
                    }

                    let x, y, found = false;
                    // 增加嘗試次數到 100 次，確保高密度下仍能放置
                    for (let attempt = 0; attempt < 100; attempt++) {
                        x = gsap.utils.random(5, 92);
                        y = gsap.utils.random(zone.yMin, zone.yMax);
                        const pxX = (window.innerWidth * x) / 100;
                        const pxY = (window.innerHeight * y) / 100;

                        if (!isOverlapping(pxX, pxY, size)) {
                            placedFlowers.push({ x: pxX, y: pxY, size: size });
                            f.style.left = x + '%';
                            f.style.top = y + '%';
                            f.style.width = size + 'px';
                            f.style.height = size + 'px';
                            found = true;
                            break;
                        }
                    }

                    if (found) {
                        f.style.backgroundImage = `url('${file}')`;
                        overlay.appendChild(f);
                    }
                }
            });
            console.log(`Initialized ${placedFlowers.length} flowers.`);
        }

        function toggleCeremony() {
            const overlay = document.getElementById('ceremony-overlay');
            const flowers = document.querySelectorAll('.flower-item');
            if (!isCeremonyActive) {
                gsap.to(overlay, { top: 0, duration: 1.8, ease: "power4.inOut" });
                gsap.to(flowers, { 
                    scale: 1, duration: 1.2, delay: 1.4,
                    stagger: { amount: 1.8, from: "random" },
                    ease: "back.out(1.5)"
                });
                isCeremonyActive = true;
            } else {
                gsap.to(flowers, { scale: 0, duration: 0.6 });
                gsap.to(overlay, { top: "-110%", duration: 1.5, delay: 0.3, ease: "power4.inOut" });
                isCeremonyActive = false;
            }
        }

        window.onload = () => {
            document.getElementById('bg-blurred').classList.add('is-clear');
            initCeremony();
            const container = document.getElementById('card-container');
            container.innerHTML = `<div class="message-card"><div class="sender">— Maggie & Stanley —</div><div class="content">Wedding Ceremony Testing<br>Ready to Bloom</div></div>`;
            
            fetch(gasUrl).then(res => res.json()).then(data => {
                if(data.length > 0) messages = data.map(d => ({ name: d.賓客姓名 || d.name, msg: d.祝福語 || d.msg }));
                rotateMessage();
            }).catch(e => rotateMessage());
        };

        function rotateMessage() {
            if (isCeremonyActive) return;
            const container = document.getElementById('card-container');
            const data = messages[currentIndex];
            container.innerHTML = `<div class="message-card"><div class="sender">— ${data.name} —</div><div class="content">${data.msg.replace(/\n/g, '<br>')}</div><div class="wedding-tag">Forever Love 2026.04 @ Mandarin Oriental Taipei</div></div>`;
            currentIndex = (currentIndex + 1) % messages.length;
        }

        setInterval(rotateMessage, 12000);

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') { e.preventDefault(); toggleCeremony(); }
        });
    </script>
</body>
</html>
