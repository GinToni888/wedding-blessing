<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>婚禮線上祝福</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f9f4f4; display: flex; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { color: #d63384; text-align: center; margin-bottom: 25px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-size: 14px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 8px; box-sizing: border-box; background-color: #fdfdfd; }
        input[readonly] { background-color: #f5f5f5; color: #888; cursor: not-allowed; }
        button { width: 100%; padding: 15px; background-color: #d63384; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:active { background-color: #b02a6a; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #loading { text-align: center; color: #d63384; }
        .my-swal-title { color: #d63384 !important; }
    </style>
</head>
<body>
    <div class="card" id="form-container" style="display:none;">
        <h2>送上祝福</h2>
        <div class="input-group">
            <label>顯示名稱 (預設為 LINE 暱稱，可修改)</label>
            <input type="text" id="name" placeholder="請輸入您想顯示的名稱">
        </div>
        <div class="input-group">
            <label>想對新人說的話</label>
            <textarea id="message" rows="5" placeholder="在此輸入您的祝福..." required></textarea>
        </div>
        <button id="submitBtn" onclick="sendBlessing()">送出祝福</button>
    </div>
    
    <div id="loading">載入中，請稍候...</div>

    <script>
        const liffId = "2008923022-EZkZfxJf"; 
        const gasUrl = "https://script.google.com/macros/s/AKfycbyFYRF2DL0gqOeAybR3UOBQv9jC58S5AWNPoicQuFSM2LZT-HXP57UZC-UdAfZJYZFEOQ/exec"; 

        async function main() {
            try {
                await liff.init({ liffId: liffId });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    document.getElementById('name').value = profile.displayName; 
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('form-container').style.display = 'block';
                }
            } catch (err) {
                console.error("LIFF 初始化失敗", err);
            }
        }

        async function sendBlessing() {
            const name = document.getElementById('name').value;
            const message = document.getElementById('message').value;
            const btn = document.getElementById('submitBtn');

            if (!message) {
                Swal.fire({
                    title: 'Maggie and Stanley',
                    text: '請輸入想對新人說的祝福',
                    icon: 'warning',
                    confirmButtonColor: '#d63384'
                });
                return;
            }

            const profile = await liff.getProfile();
            const userId = profile.userId;

            const originalText = btn.innerText;
            btn.innerText = "傳送中...";
            btn.disabled = true;

            try {
                // 1. 先將資料送往 Google 試算表
                const response = await fetch(gasUrl, {
                    method: "POST",
                    body: JSON.stringify({ 
                        name: name, 
                        message: message, 
                        userId: userId 
                    })
                });

                if (response.ok) {
                    // 2. 資料成功寫入後，讓賓客手機自動發送「關鍵字」
                    // 檢查是否在 LINE App 內，且具備發送訊息權限
                    if (liff.isInClient()) {
                        try {
                            await liff.sendMessages([{
                                'type': 'text',
                                'text': '感謝卡' // 這裡要跟妳 LINE 後台設定的關鍵字完全一致
                            }]);
                            console.log("關鍵字訊息已發送");
                        } catch (sendErr) {
                            console.error("發送訊息失敗", sendErr);
                        }
                    }

                    // 3. 顯示成功彈窗
                    Swal.fire({
                        title: 'Maggie and Stanley',
                        text: `祝福已順利寄出！謝謝你，${name}`,
                        icon: 'success',
                        confirmButtonColor: '#d63384',
                        confirmButtonText: '關閉視窗',
                        background: '#ffffff',
                        customClass: { title: 'my-swal-title' }
                    }).then(() => {
                        liff.closeWindow(); 
                    });
                } else {
                    throw new Error("API 回應錯誤");
                }
            } catch (err) {
                Swal.fire({
                    title: 'Maggie and Stanley',
                    text: '傳送失敗，請再試一次',
                    icon: 'error',
                    confirmButtonColor: '#d63384'
                });
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        main();
    </script>
</body>
</html>
